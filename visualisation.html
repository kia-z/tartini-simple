<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tartini Database</title>
    <meta name="description" content="Database interface for the project Tartinians in Europe">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#header').load('header.html');
        });
    </script>
    <script src="js/suggestions.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    </head>
<body>
    <!-- start header (incl.navbar) -->
    <div id="header"></div>
    <!-- end header -->
    <main>
        <div class="container mt-5">
            <h2>PLAYING WITH VISUALISATIONS</h2>
            <h4>Knowledge Graph Attempt</h4>
            <p>Made with D3.js (so it is GAMS-compatible).</p>
            <div id="knowledge_graph">
                <svg width="800" height="600"></svg>
    
                <script>
async function fetchGraphData(targetId = null) {
const peopleRes = await fetch(`https://script.google.com/macros/s/AKfycbyBBRlu5qk8SgG-QJhAhriKSLwLh7HJ4DH5KmUyLc2aggftNvHyB3LOKNqQC0CM2cNB3w/exec?action=get_all_people`, {
    method: "GET"  });
const peopleData = await peopleRes.json(); 

const activitiesRes = await fetch(`https://script.google.com/macros/s/AKfycbyBBRlu5qk8SgG-QJhAhriKSLwLh7HJ4DH5KmUyLc2aggftNvHyB3LOKNqQC0CM2cNB3w/exec?action=get_all_activities`, {
    method: "GET"  });
const activitiesData = await activitiesRes.json();

const worksRes = await fetch(`https://script.google.com/macros/s/AKfycbyBBRlu5qk8SgG-QJhAhriKSLwLh7HJ4DH5KmUyLc2aggftNvHyB3LOKNqQC0CM2cNB3w/exec?action=get_all_works`, {
    method: "GET"  });
const worksData = await worksRes.json();

const placesRes = await fetch(`https://script.google.com/macros/s/AKfycbyBBRlu5qk8SgG-QJhAhriKSLwLh7HJ4DH5KmUyLc2aggftNvHyB3LOKNqQC0CM2cNB3w/exec?action=get_all_places`, {
    method: "GET"  });
const placesData = await placesRes.json();

const linksRes = await fetch(`https://script.google.com/macros/s/AKfycbyBBRlu5qk8SgG-QJhAhriKSLwLh7HJ4DH5KmUyLc2aggftNvHyB3LOKNqQC0CM2cNB3w/exec?action=get_all_relations`, {
    method: "GET"  });
const linksData = await linksRes.json();
console.log("linksData:", linksData);

function sheetToNodes(rows, type) {
  if (!Array.isArray(rows) || !Array.isArray(rows[0])) return [];
  const [header, ...data] = rows[0]; 
  return data.map(row => {
    const obj = {};
    header.forEach((key, i) => {
      obj[key] = row[i];
    });
    return {
      id: obj.person_name || obj.activity_title || obj.work_title || obj.place_name || obj.id,
      label: obj.person_name || obj.activity_title || obj.work_title || obj.place_name || "Unnamed",
      type: type,
      raw: obj
    };
  });
}

const nodes = [
  ...sheetToNodes(peopleData, "person"),
  ...sheetToNodes(activitiesData, "activity"),
  ...sheetToNodes(worksData, "work"),
  ...sheetToNodes(placesData, "place")
];

function sheetToLinks(rows) {
  if (!Array.isArray(rows) || !Array.isArray(rows[0])) return [];
  const [header, ...data] = rows[0]; 
  return data.map(row => {
    const obj = {};
    header.forEach((key, i) => {
      obj[key] = row[i];
    });
    return {
      source: obj.relation_source_id,
      target: obj.relation_target_id,
      label: obj.relation_type
    };
  });
}

 const links = sheetToLinks(linksData);

  console.log("NODES:", nodes);
  console.log("LINKS:", links);

  
  const factoidRes = await fetch(`https://script.google.com/macros/s/AKfycbyBBRlu5qk8SgG-QJhAhriKSLwLh7HJ4DH5KmUyLc2aggftNvHyB3LOKNqQC0CM2cNB3w/exec?action=get_all_factoids`, {
      method: "GET"
      })
  const factoidData = await factoidRes.json();


  function sheetToFactoidNodes(rows) {
  if (!Array.isArray(rows) || !Array.isArray(rows[0])) return [];

  const [header, ...data] = rows;

  return data.map((row, index) => {
    const obj = {};
    header.forEach((key, i) => {
      obj[key] = row[i];
    });

    return {
      id: `factoid_${index}`, // Unique ID for the factoid node
      type: "factoid",
      label: `${obj.factoid_date_from || ""} ${obj.factoid_notes || ""}`.trim(),
      raw: obj
    };
  });
}

function sheetToFactoidLinks(rows) {
  if (!Array.isArray(rows) || !Array.isArray(rows[0])) return [];

  const [header, ...data] = rows;

  return data.flatMap((row, index) => {
    const obj = {};
    header.forEach((key, i) => {
      obj[key] = row[i];
    });

    const factoidId = `factoid_${index}`;

    return [
      {
        source: obj.factoid_source_id,
        target: factoidId,
        label: obj.factoid_relationship_type || "factoid-link"
      },
      {
        source: factoidId,
        target: obj.factoid_target_id,
        label: obj.factoid_relationship_type || "factoid-link"
      }
    ];
  });
}

const factoidNodes = sheetToFactoidNodes(factoidData);
const factoidLinks = sheetToFactoidLinks(factoidData);

console.log("FACTOID NODES:", factoidNodes);
console.log("FACTOID LINKS:", factoidLinks);

  return {
    nodes: [...nodes, ...factoidNodes],
    links: [...links, ...factoidLinks]
  };
}
                
function renderGraph(nodes, links) {
      const svg = d3.select("svg"),
            width = +svg.attr("width"),
            height = +svg.attr("height");

      const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2));

      const link = svg.append("g")
        .attr("stroke", "#aaa")
        .selectAll("line")
        .data(links)
        .join("line");

      const node = svg.append("g")
        .attr("stroke", "#fff")
        .attr("stroke-width", 1.5)
        .selectAll("circle")
        .data(nodes)
        .join("circle")
        .attr("r", 8)
        .attr("fill", d => {
          const colors = {
            person: "#4f81bd",
            activity: "#f79646",
            work: "#93c47d",
            place: "#b4a7d6",
            factoid: "#ddd"
          };
          return colors[d.type] || "#999";
        })
        .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended));

      const label = svg.append("g")
        .selectAll("text")
        .data(nodes)
        .join("text")
        .text(d => d.label || d.id)
        .attr("font-size", 10)
        .attr("dx", 12)
        .attr("dy", 4);

      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        node
          .attr("cx", d => d.x)
          .attr("cy", d => d.y);

        label
          .attr("x", d => d.x)
          .attr("y", d => d.y);
      });

      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }

      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }
    }

    // Call data for graph
    fetchGraphData("p1")  // or leave blank for all
      .then(({ nodes, links }) => {
        const nodeIds = new Set(nodes.map(n => n.id));
const badLinks = links.filter(link => !nodeIds.has(link.source) || !nodeIds.has(link.target));
if (badLinks.length) {
  console.warn("⚠️ These links refer to missing nodes:", badLinks);
}
const safeLinks = links.filter(link => nodeIds.has(link.source) && nodeIds.has(link.target));
renderGraph(nodes, safeLinks);
      })
      .catch(err => console.error("Error loading graph data:", err));

                </script>
                
            </div>
        </main>
        <!-- start footer -->
        <footer>
            <script type="text/javascript">
                $(document).ready(function () {
                    $('#myfooter').load('footer.html');
                });
            </script>
            <div id="myfooter"></div>
        </footer>
        <!-- end footer -->
    
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    </body>
    </html>